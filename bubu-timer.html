<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0" />
        <link rel="stylesheet" type="text/css" href="bubu-timer.css" />
        <!--<script language="JavaScript" src="bubu-timer.js" />-->
        <script language="JavaScript">

/*global timer*/

var alarm1 = new Audio("alarm1.mp3"),
    alarm2 = new Audio("alarm2.mp3"),

    ui = {

        show: function (seconds) {

            var
                remainingSeconds = seconds,
                digitsTd = document.querySelectorAll("#digits td");
            [10, 6,, 10, 1000].forEach(function (factor, index) {
                if (!factor) {
                    return;
                }
                var digit = remainingSeconds % factor;
                remainingSeconds = (remainingSeconds - digit) / factor;
                digitsTd[digitsTd.length - index - 1].innerHTML = digit;
            });

        },

        notify: function (event) {
            if (timer.PAUSED === event) {

            }
            if (remainingSeconds === 5) {
                alarm1.play();
            } else if (remainingSeconds === 0) {
                alarm2.play();
            }
        }

    };

    seconds = 0,
    sequence = [],
    repeat = 1,
    running,
    paused = false;

function pause () {
    paused = true;
}

function play () {
    document.body.className = "running";
    if (paused) {
        paused = false;
    } else {
        alarm2.play();
        var localSequence = [].concat(sequence), // TODO repeat as many time as necessary
            localSeconds,
            paused = false;
        running = setInterval(function () {
            if (paused) {
                return;
            }
            if (!localSeconds) {
                localSeconds = localSequence.shift();
                if (!localSeconds) {
                    clearInterval(running);
                    running = 0;
                    document.body.className = "";
                    return;
                }
            } else {
                --localSeconds;
            }
            show(localSeconds);
            if (localSeconds === 5) {
                alarm1.play();
            }
            if (localSeconds === 0) {
                alarm2.play();
            }
        }, 1000);
    }
}

function _adjustSeconds (index, sign) {
    var diff = [600, 60,, 10, 1][index];
    if (diff) {
        var newValueForSeconds = seconds + sign * diff;
        if (newValueForSeconds <= 0) {
            newValueForSeconds = 0;
        }
        seconds = newValueForSeconds;
        show(seconds);
    }
}

function inc (e, index) {
    _adjustSeconds(index, 1);
}

function dec (e, index) {
    _adjustSeconds(index, -1);
}

function refreshSequence () {
    document.getElementById("sequence").innerHTML = sequence.map(function (itemSeconds) {
        var mins = Math.floor(itemSeconds/ 60),
            secs = itemSeconds % 60,
            label;
        if (secs < 10) {
            label =  mins + ":0" + secs;
        } else {
            label =  mins + ":" + secs;
        }
        return "<li>" + label + "</li>";
    }).join("");
}

function add() {
    sequence.push(seconds);
    refreshSequence();
}

function onLoad() {
    document.addEventListener("click", function (e) {
        var target = e.target;
        if ("function" === typeof window[target.id]) {
            window[target.id](e);
        }
        var parent = target.parentNode,
            sibling = target,
            position = 0;
        if (parent.id && "function" === typeof window[parent.id]) {
            while (sibling !== parent.firstChild) {
                sibling = sibling.previousSibling;
                ++position;
            }
            window[parent.id](e, position);
        }
    });
    show(seconds);
}
// Initial 5 addtional seconds to have time to setup

        </script>
    </head>
    <body onload="onLoad()">
        <table id="new_timer" width="100%">
            <tr id="inc" class="action"><td>&#9206;</td><td>&#9206;</td><td>&nbsp;</td><td>&#9206;</td><td>&#9206;</td></tr>
            <tr id="digits"><td>0</td><td>0</td><td>:</td><td>0</td><td>0</td></tr>
            <tr id="dec" class="action"><td>&#9207;</td><td>&#9207;</td><td>&nbsp;</td><td>&#9207;</td><td>&#9207;</td></tr>
        </table>
        <div id="toolbar">
            <div id="add" class="action">+</div>
            <div id="repeatLess" class="action">-</div>
            <div id="repeat">1</div>
            <div id="repeatMore" class="action">+</div>
        </div>
        <div class="controls">
            <div id="play">&#9658;</div>
            <div id="pause">&#9208;</div>
            <div id="stop">&#9209;</div>
        </div>
        <ul id="sequence"></ul>
    </body>
</html>
